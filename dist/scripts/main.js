"use strict";var _zarr=function(r){return new Array(r).join(0).split("").map(Number)},_rclarr=function(r){return"object"==typeof r?[].map.call(r,_rclarr):r},tetrisWidth=20,tetrisHeight=30,tetrisFigs=[[[1,1,1],[0,1,0]],[[1,1,0],[0,1,1]],[[0,1,1],[1,1,0]],[[1,1,1],[0,0,1]],[[1,1,1],[1,0,0]],[[1,1],[1,1]],[[1,1,1,1]]],tetris={},viewwork={};tetris={state:_zarr(tetrisHeight+4).map(function(){return _zarr(tetrisWidth+1)}),currPos:{x:null,y:null,dx:null,dy:null},currFig:null,possFig:_rclarr(tetrisFigs),checkPos:function(r,t,i){var e=this;return i=i||this.currFig,i.every(function(i,s){return i.every(function(i,c){return i+e.state[s+t][c+r]<2})})},calcState:function(){var r=this;this.state.forEach(function(t,i){t.some(function(r){return 0===r})||(r.state.splice(i,1),r.state.push(_zarr(r.state[0].length+1)))})},showState:function(){var r=this,t=_rclarr(this.state);if(this.currFig){if(!this.checkPos(this.currPos.x,this.currPos.y))return t;r.currFig.forEach(function(i,e){i.forEach(function(i,s){t[e+r.currPos.y][s+r.currPos.x]+=i})})}return t},saveState:function(){this.state=this.showState(),this.currFig=null,this.currPos={x:null,y:null,dx:null,dy:null},this.calcState()},moveRL:function(r){this.currPos.x+r<0||this.currPos.x+this.currFig[0].length+r>this.state[0].length||this.checkPos(this.currPos.x+r,this.currPos.y)&&(this.currPos.x+=r)},moveD:function(){this.currFig&&(this.currPos.y-1<0||!this.checkPos(this.currPos.x,this.currPos.y-1)?this.saveState():this.currPos.y-=1)},fullD:function(){this.currFig&&(this.moveD(),this.fullD())},showTurn:function(){if(this.currFig){var r=this;return _rclarr(r.currFig)[0].map(function(t,i){return _rclarr(r.currFig).map(function(t,e){return _rclarr(r.currFig)[e][r.currFig[0].length-i-1]})})}},rotate:function(){if(this.currFig){var r=this,t=r.showTurn(),i=Math.floor((r.currFig[0].length-t[0].length)/2),e=Math.floor((r.currFig.length-t.length)/2);i=null===r.currPos.dx?i:-r.currPos.dx,e=null===r.currPos.dy?e:-r.currPos.dy,r.currPos.x+i<0&&(i=-r.currPos.x),r.currPos.x+i+t[0].length>r.state[0].length&&(i=r.state[0].length-r.currPos.x-t[0].length),r.checkPos(r.currPos.x+i,r.currPos.y+e,t)&&(r.currFig=_rclarr(t),r.currPos={x:r.currPos.x+i,y:r.currPos.y+e,dx:i,dy:e})}},newFig:function(){if(!this.currFig){var r=this,t=Math.max(Math.floor(Math.random()*this.possFig.length-.1),0);this.currFig=_rclarr(this.possFig[t]),this.currPos.x=Math.floor(this.state[0].length/2-this.currFig[0].length/2),this.currPos.y=this.state.length-this.currFig.length-3,_zarr(Math.floor(4*Math.random())).forEach(function(){r.rotate()})}},out:function(){return this.showState().slice(0,this.showState().length-3)}},viewwork={init:function(){document.addEventListener("keyup",function(r){switch(r.keyCode){case 37:tetris.moveRL(-1);break;case 39:tetris.moveRL(1);break;case 38:tetris.rotate();break;case 40:tetris.fullD(),viewwork.iterate()}}),viewwork.iterate()},draw:function(){var r=document.getElementById("space"),t=document.createElement("div");for(t.innerHTML=tetris.out().reverse().map(function(r){return'<div class="line">'+r.map(function(r){return(r?'<div class="black">':'<div class="white">')+r+"</div>"}).join("")+"</div>"}).join("");r.firstChild;)r.removeChild(r.firstChild);r.appendChild(t)},iterate:function(){tetris.moveD(),viewwork.draw(),tetris.calcState(),tetris.newFig(),viewwork.draw()}},viewwork.init(),setInterval(function(){viewwork.iterate()},500);